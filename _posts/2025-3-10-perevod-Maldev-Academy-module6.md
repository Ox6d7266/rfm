---
layout: post
title: "Модуль 6 MalDev Academy на русском"
---

**Модуль 6 MalDev Academy на русском**
![]({{ site.baseurl }}/images/m41.jpg)

***Что такое процесс в ОС Windows***

Процесс Windows - это программа или приложение, которое запущено на компьютере c виндой. Процесс может запустить либо пользователь, либо система. 
Он потребляет ресурсы, такие как процессерное время, память и место на диске.

***Process Threads***

Процессы Винды состоят из потоков, их может быть несколько и они выполняются одновременно. 
Поток это набор инструкций, может выполняться независимо внутри процесса и при этом обмениваться данными с другими потоками. 
Винда планирует выполнение потоков и управляет ими. 

***Process Memory***

Процесс использует память для хранения там данных и инструкций. Память выделяется при создании процесса и объем будет установлен из инструкций при создании процесса.
В винде есть виртуальная и физическая память, для управления объемами памяти и для предовращения ошибок ос может создать виртуальное адресное пространство.  Эти пространства уже и разделены на страницы. 

![]({{ site.baseurl }}/images/m42.jpg)

***Memory Types***

Процессы могут использовать разные типы памяти:

- Частная память (Private memory):
	  1.Это память, выделенная исключительно одному процессу.
	  2.Другие процессы не могут к ней получить доступ.
	  3.Используется для хранения данных, относящихся только к этому процессу.

- Отображаемая память (Mapped memory):
	  1.Может быть разделена между несколькими процессами.
	  2.Используется для обмена данными, например, через общие библиотеки, сегменты общей памяти и общие файлы.
	  3.Она видна другим процессам, но защищена от изменений ими.

- Образ памяти (Image memory):
	  1.Содержит код и данные исполняемого файла.
	  2.Используется для хранения кода программы, данных и ресурсов.
	  3.Часто связана с DLL файлами, загружаемыми в адресное пространство процесса.

***Process Environment Block (PEB)***


- PEB как "досье" процесса: Представь PEB как подробное досье на каждый запущенный процесс. В нем хранится все необходимое для ос и самого процесса.

- PEB содержит важные данные, такие как PID (уникальный идентификатор процесса), путь к исполняемому файлу, параметры запуска и список загруженных библиотек (DLL).

- PEB используется при запуске процесса и постоянно обновляется во время его работы, позволяя операционной системе отслеживать и управлять процессом.

- Каждый процесс имеет свой уникальный PEB, что обеспечивает изоляцию и независимость процессов друг от друга.

 ***PEB Structure***

Так выглядит структура PEB на языке Си
```
 typedef struct _PEB {
  BYTE                          Reserved1[2]; 
  BYTE                          BeingDebugged; 
  BYTE                          Reserved2[1]; 
  PVOID                         Reserved3[2]; 
  PPEB_LDR_DATA                 Ldr; 
  PRTL_USER_PROCESS_PARAMETERS  ProcessParameters; 
  PVOID                         Reserved4[3]; 
  PVOID                         AtlThunkSListPtr; 
  PVOID                         Reserved5; 
  ULONG                         Reserved6; 
  PVOID                         Reserved7; 
  ULONG                         Reserved8; 
  ULONG                         AtlThunkSListPtr32; 
  PVOID                         Reserved9[45]; 
  BYTE                          Reserved10[96]; 
  PPS_POST_PROCESS_INIT_ROUTINE PostProcessInitRoutine; 
  BYTE                          Reserved11[128]; 
  PVOID                         Reserved12[1]; 
  ULONG                         SessionId; 
} PEB, *PPEB;

```
Нам интересны:

- `BeingDebugged` - это флаг у которого может быть значение 1 или 0. Показывает ос необходимо ли запускать приложение с подключенным отладчиком. 

- `Ldr` — это указатель на структуру `PEB_LDR_DATA` в блоке Process Environment Block (PEB). Эта структура содержит информацию о загруженных модулей динамической библиотеки компоновки (DLL) процесса. Он включает в себя список загруженных в процессе библиотек DLL, базовый адрес каждой библиотеки DLL и размер каждого модуля. Он используется загрузчиком Windows для отслеживания загруженных в процессе DLL. Структура `PEB_LDR_DATA` показана ниже.

```
typedef struct _PEB_LDR_DATA { 
  BYTE       Reserved1[8]; 
  PVOID      Reserved2[3]; 
  LIST_ENTRY InMemoryOrderModuleList; 
} PEB_LDR_DATA, *PPEB_LDR_DATA; 
```
`Ldr` можно использовать для поиска базового адреса конкретной библиотеки DLL, а также для определения функций, находящихся в ее памяти. Это будет использоваться в будущих модулях для создания пользовательской версии GetModuleHandleA/W для дополнительной скрытности.

- `ProcessParameters` — это структура данных в PEB. Он содержит параметры командной строки, передаваемые процессу при создании. Загрузчик Windows добавляет эти параметры в структуру PEB процесса. `ProcessParameters` — это указатель на структуру `RTL_USER_PROCESS_PARAMETERS`, показанную ниже.

```
 typedef struct _RTL_USER_PROCESS_PARAMETERS { 
  BYTE           Reserved1[16]; 
  PVOID          Reserved2[10]; 
  UNICODE_STRING ImagePathName; 
  UNICODE_STRING CommandLine; 
} RTL_USER_PROCESS_PARAMETERS, *PRTL_USER_PROCESS_PARAMETERS; 
```


- `AtlThunkSListPtr` и `AtlThunkSListPtr32` используются модулем ATL (Active Template Library) для хранения указателя на связанный список функций преобразования. Функции преображения используются для вызова функций, реализованных в другом адресном пространстве, они часто представляют собой функции, экспортированные из файла DLL (Dynamic Link Library).

- `PostProcessInitRoutine` в структуре PEB используется для хранения указателя на функцию, которая вызывается операционной системой после завершения инициализации TLS (Thread Local Storage) для всех потоков в процессе. Эта функция может быть использована для выполнения любых дополнительных задач инициализации, которые требуются для процесса. 

- `SessionID` в PEB — это уникальный идентификатор, присваиваемый одному сеансу. Он используется для отслеживания активности пользователя во время сеанса.

![]({{ site.baseurl }}/images/m43.jpg)

***Thread Environment Block (TEB)***

TEB — это структура данных в Windows, которая хранит информацию о потоке. Он содержит среду потока, контекст безопасности и другую связанную информацию. Он хранится в стеке потоков и используется ядром Windows для управления потоками.

Структура TEB на языке Си ниже

```
 typedef struct _TEB {
  PVOID Reserved1[12]; 
  PPEB  ProcessEnvironmentBlock; 
  PVOID Reserved2[399]; 
  BYTE  Reserved3[1952]; 
  PVOID TlsSlots[64]; 
  BYTE  Reserved4[8]; 
  PVOID Reserved5[26]; 
  PVOID ReservedForOle; 
  PVOID Reserved6[4]; 
  PVOID TlsExpansionSlots; 
} TEB, *PTEB;
```


- `ProcessEnvironmentBlock` (PEB) - является указателем на структуру PEB, описанную выше, PEB расположен внутри блока Thread Environment Block (TEB) и используется для хранения информации о текущем выполняемом процессе.
 
- `Thread Local Storage` — это места в TEB, которые используются для хранения данных, относящихся к потоку. Каждый поток в Windows имеет свой собственный TEB, и каждый TEB имеет набор слотов TLS. Приложения могут использовать эти слоты для хранения данных, специфичных для этого потока, таких как переменные, дескрипторы потока, состояния, специфичные для потока, и т. д.

- `TlsExpansionSlots` - это набор указателей, используемых для хранения данных локального хранилища потока для потока. Слоты расширения TLS зарезервированы для использования системными библиотеками DLL.

***Process And Thread Handles***

В винде каждый процесс имеет идентификатор процесса (PID), который ос присваивает при создании процесса. 
PID используются для того, чтобы отличить один запущенный процесс от другого. То же самое относится и к работающему потоку, в котором выполняющийся поток имеет уникальный идентификатор, который используется для того, чтобы отличить его от остальных существующих потоков (в любом процессе) в системе. 

Эти идентификаторы можно использовать для открытия дескриптора процесса или потока с помощью указанных ниже WinAPI. 
 - OpenProcess — открывает дескриптор существующего объекта процесса через его идентификатор. 
 - OpenThread — открывает дескриптор существующего объекта потока через его идентификатор.

На данный момент достаточно знать, что открытый дескриптор может быть использован для выполнения дальнейших действий с соответствующим объектом Windows, таких как приостановка процесса или потока.

Тут дз не будет, много интересной теории, я вас оставляю тут переваривать эту инфу. 

![]({{ site.baseurl }}/images/m44.jpg)

Если интересно подпишись [сюда](https://t.me/+FgF54uwvO3MyMmIy) это мой тг канал L33trfm0x 
